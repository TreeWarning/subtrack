version: '3.8'

services:
  # --- 1. PostgreSQL Database Service ---
  db:
    image: postgres:16-alpine
    container_name: subscription_db
    restart: always
    environment:
      # These variables set up the database credentials
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: subscription_tracker_db
    ports:
      - "5432:5432" # Maps database port to your local machine (optional)
    volumes:
      # CRUCIAL: This runs your schema.sql file automatically on first startup
      - ./db/schema.sql:/docker-entrypoint-initdb.d/schema.sql
      # Data persistence for the database
      - postgres_data:/var/lib/postgresql/data/

  # --- 2. Node.js Backend/API Service ---
  api:
    build:
      context: . # Looks for a 'Dockerfile' in the current directory
    container_name: subscription_api
    restart: always
    ports:
      - "3001:3001" # Exposes API port 3001 to your local machine
    environment:
      # This is how the API connects to the 'db' service
      PGUSER: user
      PGPASSWORD: password
      PGDATABASE: subscription_tracker_db
      PGHOST: db # IMPORTANT: Uses the service name 'db' as the hostname
      PGPORT: 5432
    depends_on:
      - db # Ensures the database starts before the API
    volumes:
      # Syncs your local code for development (your current directory to the container's working directory)
      - .:/usr/src/app 

volumes:
  postgres_data: